name: Deploy to Hugging Face Space (Full Auto)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. ä¿®æ”¹ Config (ä½¿ç”¨ç»å¯¹è·¯å¾„ /data/)
      # è¿™æ ·æ— è®º URL æ˜¯ /galaxy è¿˜æ˜¯ /foo/barï¼Œå®ƒéƒ½ä¼šåŽ»æ ¹ç›®å½•æ‰¾ data
      - name: Configure Data Source
        run: |
          sed -i "s|http://localhost:9090/|/data/|g" src/config.js
          echo "Config updated: Data source set to absolute path '/data/'"
          grep "dataUrl" src/config.js

      # 2. ä»Žé˜¿é‡Œäº‘ä¸‹è½½æ•°æ® (å¸¦è°ƒè¯•)
      - name: Download Data from Aliyun
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          mkdir -p hf-data/galaxy_output_data
          
          echo "--> Test connection and list remote files:"
          sshpass -e ssh -o StrictHostKeyChecking=no root@8.159.137.183 "ls -lh /var/www/galaxy_data/my_model_galaxy/ | head -n 5"
          
          echo "--> Starting Download..."
          sshpass -e scp -o StrictHostKeyChecking=no -r root@8.159.137.183:/var/www/galaxy_data/my_model_galaxy/* hf-data/galaxy_output_data/
          
          echo "--> Local Data Check (Top 5 files):"
          ls -lh hf-data/galaxy_output_data/ | head -n 5

      # 3. æŽ¨é€åˆ° Hugging Face
      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: "MrYaoYaozhu"
          HF_SPACE_NAME: "ModelGalaxy"
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME /tmp/hf_space
          
          cd /tmp/hf_space
          find . -maxdepth 1 ! -name '.git' ! -name '.gitattributes' ! -name 'README.md' ! -name '.' -exec rm -rf {} +
          
          git lfs install
          git lfs track "hf-data/galaxy_output_data/**"
          
          # å¤åˆ¶æ–°ä»£ç  (åŒ…å«åˆšåˆšä¸‹è½½çš„ hf-data)
          cp -r $GITHUB_WORKSPACE/* .
          
          rm -f "åˆèµ›PPT.pdf" "å¤èµ›PPT.pdf"
          rm -rf .git/modules

          echo "---
          title: Model Galaxy
          emoji: ðŸŒŒ
          colorFrom: blue
          colorTo: purple
          sdk: docker
          pinned: false
          ---" > README_HEADER.md
          
          if [ -f "README.md" ]; then
            cat README_HEADER.md README.md > README_NEW.md
            mv README_NEW.md README.md
          else
            mv README_HEADER.md README.md
          fi
          rm README_HEADER.md

          git add .
          git commit -m "Deploy: fixed paths and data" --allow-empty
          git push --force