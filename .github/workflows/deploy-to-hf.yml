name: Deploy to Hugging Face Space (Docker)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Configure for Production
        run: |
          if [ -n "${{ secrets.PROD_DATA_URL }}" ]; then
            sed -i "s|http://localhost:9090/|${{ secrets.PROD_DATA_URL }}|g" src/config.js
            echo "Successfully updated config.js with production URL."
          else
            echo "Warning: PROD_DATA_URL secret is not set."
          fi

      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: "MrYaoYaozhu"
          HF_SPACE_NAME: "ModelGalaxy"
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # 1. ÂÖãÈöÜ HF ‰ªìÂ∫ì
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME /tmp/hf_space
          
          # 2. Ê∏ÖÁêÜÊóßÊñá‰ª∂ (‰øùÁïô .git)
          cd /tmp/hf_space
          find . -maxdepth 1 ! -name '.git' ! -name '.gitattributes' ! -name '.' -exec rm -rf {} +
          
          # 3. Â§çÂà∂Êñ∞‰ª£Á†Å
          cp -r $GITHUB_WORKSPACE/* .
          
          # 4. Âà†Èô§Â§ßÊñá‰ª∂
          rm -f "ÂàùËµõPPT.pdf" "Â§çËµõPPT.pdf"
          rm -rf .git/modules

          # --- ÂÖ≥ÈîÆ‰øÆÊîπÔºöËá™Âä®ÁîüÊàêÂ∏¶ÈÖçÁΩÆÁöÑ README.md ---
          # Ëøô‰∏ÄÊ≠•‰ºöÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÂ§¥ÈÉ®Êñá‰ª∂ÔºåÁÑ∂ÂêéÊää‰Ω†ÂéüÊù•ÁöÑ README Êé•Âú®ÂêéÈù¢
          echo "---
          title: Model Galaxy
          emoji: üåå
          colorFrom: blue
          colorTo: purple
          sdk: docker
          pinned: false
          ---" > README_HEADER.md
          
          # Â¶ÇÊûúÂéüÈ°πÁõÆÊúâ README.mdÔºåÂ∞±ÊãºÊé•Âà∞ÈÖçÁΩÆÂêéÈù¢ÔºõÂ¶ÇÊûúÊ≤°ÊúâÔºåÂ∞±Âè™‰øùÁïôÈÖçÁΩÆ
          if [ -f "README.md" ]; then
            cat README_HEADER.md README.md > README_NEW.md
            mv README_NEW.md README.md
          else
            mv README_HEADER.md README.md
          fi
          
          rm -f README_HEADER.md
          # ------------------------------------------

          # 5. Êèê‰∫§Âπ∂Êé®ÈÄÅ
          git add .
          git commit -m "Deploy: auto-inject readme config" --allow-empty
          git push --force