name: Deploy to Hugging Face Space (Full Auto)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. ä¿®æ”¹ Config (ä½¿ç”¨ç»å¯¹è·¯å¾„ /data/)
      - name: Configure Data Source
        run: |
          sed -i "s|http://localhost:9090/|/data/|g" src/config.js
          echo "Config updated: Data source set to absolute path '/data/'"
          grep "dataUrl" src/config.js

      # 2. ä»Žé˜¿é‡Œäº‘ä¸‹è½½æ•°æ® (æ•´æ–‡ä»¶å¤¹ä¸‹è½½)
      - name: Download Data from Aliyun
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          # åˆ›å»ºçˆ¶ç›®å½•
          mkdir -p hf-data
          
          echo "--> Starting Download from Aliyun..."
          # ã€å…³é”®ä¿®æ”¹ã€‘ç›´æŽ¥ä¸‹è½½æ•´ä¸ª my_model_galaxy æ–‡ä»¶å¤¹åˆ° hf-data ç›®å½•ä¸‹
          # ç»“æžœä¼šåœ¨ hf-data/my_model_galaxy/ é‡Œï¼Œç»“æž„éžå¸¸æ¸…æ™°
          sshpass -e scp -o StrictHostKeyChecking=no -r root@8.159.137.183:/var/www/galaxy_data/my_model_galaxy hf-data/
          
          echo "--> Data Structure Check:"
          # æ‰“å°ç›®å½•ç»“æž„ï¼Œç¡®è®¤ manifest.json åœ¨æ­£ç¡®çš„ä½ç½®
          ls -R hf-data | grep manifest.json || echo "WARNING: manifest.json not found!"

      # 3. æŽ¨é€åˆ° Hugging Face
      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: "MrYaoYaozhu"
          HF_SPACE_NAME: "ModelGalaxy"
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME /tmp/hf_space
          
          cd /tmp/hf_space
          find . -maxdepth 1 ! -name '.git' ! -name '.gitattributes' ! -name 'README.md' ! -name '.' -exec rm -rf {} +
          
          git lfs install
          # è¿½è¸ª hf-data ä¸‹çš„æ‰€æœ‰å¤§æ–‡ä»¶
          git lfs track "hf-data/**"
          
          # å¤åˆ¶æ–°ä»£ç 
          cp -r $GITHUB_WORKSPACE/* .
          
          rm -f "åˆèµ›PPT.pdf" "å¤èµ›PPT.pdf"
          rm -rf .git/modules

          # è‡ªåŠ¨ç”Ÿæˆ README é…ç½®
          echo "---
          title: Model Galaxy
          emoji: ðŸŒŒ
          colorFrom: blue
          colorTo: purple
          sdk: docker
          pinned: false
          ---" > README_HEADER.md
          
          if [ -f "README.md" ]; then
            cat README_HEADER.md README.md > README_NEW.md
            mv README_NEW.md README.md
          else
            mv README_HEADER.md README.md
          fi
          rm README_HEADER.md

          git add .
          git commit -m "Deploy: fixed folder structure" --allow-empty
          git push --force