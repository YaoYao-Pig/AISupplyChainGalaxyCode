name: Deploy to Hugging Face Space (Full Auto)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. ä¿®æ”¹ Config (ä½¿ç”¨ç»å¯¹è·¯å¾„ /data/)
      - name: Configure Data Source
        run: |
          sed -i "s|http://localhost:9090/|/data/|g" src/config.js
          echo "Config updated: Data source set to absolute path '/data/'"
          grep "dataUrl" src/config.js

      # 2. ä»Žé˜¿é‡Œäº‘ä¸‹è½½æ•°æ®
      - name: Download Data from Aliyun
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          # åˆ›å»ºçˆ¶ç›®å½•
          mkdir -p hf-data
          
          echo "--> Starting Download from Aliyun..."
          # ä¸‹è½½æ•´ä¸ª my_model_galaxy æ–‡ä»¶å¤¹
          sshpass -e scp -o StrictHostKeyChecking=no -r root@8.159.137.183:/var/www/galaxy_data/my_model_galaxy hf-data/
          
          echo "--> Data Structure Check:"
          ls -R hf-data | grep manifest.json || echo "WARNING: manifest.json not found!"

      # 3. æŽ¨é€åˆ° Hugging Face
      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: "MrYaoYaozhu"
          HF_SPACE_NAME: "ModelGalaxy"
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # å…‹éš†
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME /tmp/hf_space
          
          # æ¸…ç†æ—§æ–‡ä»¶ (ä¿ç•™ .git å’Œ .gitattributes)
          cd /tmp/hf_space
          find . -maxdepth 1 ! -name '.git' ! -name '.gitattributes' ! -name 'README.md' ! -name '.' -exec rm -rf {} +
          
          # ã€å…³é”®ä¿®æ”¹ã€‘å…ˆå¤åˆ¶æ–°æ–‡ä»¶ï¼ˆè®©ç¡¬ç›˜ä¸Šæœ‰æ–‡ä»¶ï¼‰
          echo "--> Copying new files..."
          cp -r $GITHUB_WORKSPACE/* .
          
          # ã€å…³é”®ä¿®æ”¹ã€‘ç„¶åŽå†é…ç½® LFSï¼ˆè¿™æ—¶å€™æ–‡ä»¶éƒ½åœ¨ï¼Œå°±ä¸ä¼šæŠ¥é”™äº†ï¼‰
          echo "--> Configuring LFS..."
          git lfs install
          # è¿½è¸ª hf-data ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
          git lfs track "hf-data/**"
          
          # åˆ é™¤ä¸éœ€è¦çš„ PDF å’Œ git åµŒå¥—
          rm -f "åˆèµ›PPT.pdf" "å¤èµ›PPT.pdf"
          rm -rf .git/modules

          # è‡ªåŠ¨ç”Ÿæˆ README é…ç½®
          echo "---
          title: Model Galaxy
          emoji: ðŸŒŒ
          colorFrom: blue
          colorTo: purple
          sdk: docker
          pinned: false
          ---" > README_HEADER.md
          
          if [ -f "README.md" ]; then
            cat README_HEADER.md README.md > README_NEW.md
            mv README_NEW.md README.md
          else
            mv README_HEADER.md README.md
          fi
          rm README_HEADER.md

          # æäº¤
          echo "--> Committing and Pushing..."
          git add .
          git commit -m "Deploy: fixed LFS order" --allow-empty
          git push --force