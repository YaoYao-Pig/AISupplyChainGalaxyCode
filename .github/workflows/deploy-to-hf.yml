name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-sync:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      # 2. 设置 Node.js 环境 (保持和你原有的 deploy.yml 一致)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # 3. 安装依赖
      - name: Install Dependencies
        run: npm install

      # 4. 修改配置文件 (保留你原有的逻辑，替换 localhost 为生产地址)
      # 确保你在 GitHub Secrets 里配置了 PROD_DATA_URL
      - name: Configure for Production
        run: |
          if [ -n "${{ secrets.PROD_DATA_URL }}" ]; then
            sed -i "s|http://localhost:9090/|${{ secrets.PROD_DATA_URL }}|g" src/config.js
            echo "Successfully updated config.js with production URL."
          else
            echo "Warning: PROD_DATA_URL secret is not set. Skipping config replacement."
          fi

      # 5. 构建项目 (生成 build 文件夹)
      - name: Build Project
        run: npm run build

      # 6. 推送到 Hugging Face Space
      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: "MrYaoYaozhu"
          HF_SPACE_NAME: "ModelGalaxy"
        run: |
          # 1. 配置 Git 身份
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # 2. 克隆 Hugging Face 仓库到临时目录
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME /tmp/hf_space
          
          # 3. 【关键步骤】清理旧文件
          # 进入仓库目录
          cd /tmp/hf_space
          # 删除所有文件，但保留 .git 目录和 README.md
          # 这一步是为了清除之前意外上传的 package.json
          find . -maxdepth 1 ! -name '.git' ! -name 'README.md' ! -name '.gitattributes' ! -name '.' -exec rm -rf {} +
          
          # 4. 把你刚刚构建好的 build 文件夹里的内容复制进去
          # 注意：$GITHUB_WORKSPACE 是 GitHub Action 默认的代码根目录
          cp -r $GITHUB_WORKSPACE/build/* .
          
          # 5. 提交并强制推送
          git add .
          git commit -m "Deploy clean static site" --allow-empty
          git push --force