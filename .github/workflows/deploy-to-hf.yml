name: Deploy to Hugging Face Space (Clean Force)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. ä¿®æ”¹ Config (ç»å¯¹è·¯å¾„)
      - name: Configure Data Source
        run: |
          sed -i "s|http://localhost:9090/|/data/|g" src/config.js
          echo "Config updated: Data source set to absolute path '/data/'"

      # 2. ä»é˜¿é‡Œäº‘ä¸‹è½½æ•°æ® (ç»“æ„: hf-data/my_model_galaxy)
      - name: Download Data from Aliyun
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          mkdir -p hf-data
          
          echo "--> Starting Download from Aliyun..."
          # ç›´æ¥ä¸‹è½½ my_model_galaxy æ–‡ä»¶å¤¹åˆ° hf-data ç›®å½•ä¸‹
          sshpass -e scp -o StrictHostKeyChecking=no -r root@8.159.137.183:/var/www/galaxy_data/my_model_galaxy hf-data/
          
          echo "--> Verifying Data..."
          ls -R hf-data | grep manifest.json || echo "WARNING: manifest.json missing!"

      # 3. æ¨é€åˆ° Hugging Face (ä½¿ç”¨å­¤å„¿åˆ†æ”¯ç­–ç•¥)
      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: "MrYaoYaozhu"
          HF_SPACE_NAME: "ModelGalaxy"
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # A. å…‹éš†ä»“åº“ (ä»…ç”¨äºè·å–è¿œç¨‹åœ°å€å’Œæƒé™)
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME /tmp/hf_space
          cd /tmp/hf_space
          
          # B. ã€æ ¸å¿ƒç»æ‹›ã€‘åˆ‡æ¢åˆ°å­¤å„¿åˆ†æ”¯ (Orphan Branch)
          # è¿™ä¼šåˆ›å»ºä¸€ä¸ªæ²¡æœ‰ä»»ä½•å†å²è®°å½•çš„å…¨æ–°åˆ†æ”¯ï¼Œç›¸å½“äºä¸€å¼ ç™½çº¸
          git checkout --orphan clean-deploy
          
          # C. æ¸…ç©ºæš‚å­˜åŒºå’Œå·¥ä½œåŒº (å½»åº•æ¸…é™¤æ‰€æœ‰æ—§æ–‡ä»¶çš„å¹½çµ)
          git rm -rf .
          
          # D. å¤åˆ¶æ–°æ–‡ä»¶è¿›æ¥
          # ç°åœ¨ç›®å½•æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬æŠŠ GitHub é‡Œçš„æ–°ä»£ç å’Œæ•°æ®æ¬è¿›æ¥
          echo "--> Copying new files..."
          cp -r $GITHUB_WORKSPACE/* .
          
          # E. æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -f "åˆèµ›PPT.pdf" "å¤èµ›PPT.pdf"
          rm -rf .git/modules
          
          # F. é‡æ–°åˆå§‹åŒ– LFS (åœ¨æ–°ç¯å¢ƒä¸‹è¿½è¸ª)
          git lfs install
          # è¿½è¸ª hf-data ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ (ç¡®ä¿å¤§æ–‡ä»¶è¢« LFS ç®¡ç†)
          git lfs track "hf-data/**"
          
          # G. ç”Ÿæˆé…ç½®æ–‡ä»¶
          echo "---
          title: Model Galaxy
          emoji: ğŸŒŒ
          colorFrom: blue
          colorTo: purple
          sdk: docker
          pinned: false
          ---" > README_HEADER.md
          
          if [ -f "README.md" ]; then
            cat README_HEADER.md README.md > README_NEW.md
            mv README_NEW.md README.md
          else
            mv README_HEADER.md README.md
          fi
          rm README_HEADER.md
          
          # H. æäº¤å¹¶å¼ºåˆ¶æ¨é€åˆ° main
          git add .
          git commit -m "Deploy: clean force push with new data structure"
          
          # å¼ºåˆ¶æŠŠè¿™ä¸ªå…¨æ–°çš„å­¤å„¿åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹çš„ main åˆ†æ”¯
          # è¿™ä¼šè¦†ç›–æ‰è¿œç¨‹æ‰€æœ‰çš„æ—§å†å²ï¼Œå½»åº•æ ¹é™¤ LFS æŠ¥é”™
          git push --force origin clean-deploy:main