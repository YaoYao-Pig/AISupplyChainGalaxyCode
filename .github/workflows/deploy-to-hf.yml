name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-sync:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      # 2. 设置 Node.js 环境 (保持和你原有的 deploy.yml 一致)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # 3. 安装依赖
      - name: Install Dependencies
        run: npm install

      # 4. 修改配置文件 (保留你原有的逻辑，替换 localhost 为生产地址)
      # 确保你在 GitHub Secrets 里配置了 PROD_DATA_URL
      - name: Configure for Production
        run: |
          if [ -n "${{ secrets.PROD_DATA_URL }}" ]; then
            sed -i "s|http://localhost:9090/|${{ secrets.PROD_DATA_URL }}|g" src/config.js
            echo "Successfully updated config.js with production URL."
          else
            echo "Warning: PROD_DATA_URL secret is not set. Skipping config replacement."
          fi

      # 5. 构建项目 (生成 build 文件夹)
      - name: Build Project
        run: npm run build

      # 6. 推送到 Hugging Face Space
      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: "你的HF用户名"
          HF_SPACE_NAME: "你的Space名称"
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # 1. 克隆仓库
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME /tmp/hf_space
          
          # 2. 【新增】清理旧文件 (保留 .git 和 README.md)
          cd /tmp/hf_space
          find . -maxdepth 1 ! -name '.git' ! -name 'README.md' ! -name '.gitattributes' ! -name '.' -exec rm -rf {} +
          
          # 3. 复制新构建的文件
          # 注意：这里假设你在上一步构建生成的 build 目录在 GitHub 工作区的根目录下
          # 我们需要回到 GitHub 工作区把文件拷过来
          cp -r $GITHUB_WORKSPACE/build/* .
          
          # 4. 提交并推送
          git add .
          git commit -m "Deploy: clean and push" --allow-empty
          git push --force