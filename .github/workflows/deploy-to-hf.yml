name: Deploy to Hugging Face Space (Full Auto)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      # 1. Ê£ÄÂá∫‰ª£Á†Å
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. ‰øÆÊîπÂâçÁ´ØÈÖçÁΩÆ (ÊåáÂêëÊú¨Âú∞ data/)
      - name: Configure Data Source
        run: |
          sed -i "s|http://localhost:9090/|data/|g" src/config.js
          echo "Config updated: Data source set to 'data/'"

      # 3. „ÄêÊ†∏ÂøÉÊ≠•È™§„Äë‰ªéÈòøÈáå‰∫ë‰∏ãËΩΩÊï∞ÊçÆ
      - name: Download Data from Aliyun
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          # A. ÂÆâË£Ö sshpass (Áî®‰∫éÂú®ÂëΩ‰ª§Ë°åËæìÂÖ•ÂØÜÁ†Å)
          sudo apt-get update
          sudo apt-get install -y sshpass

          # B. ÂàõÂª∫Â≠òÊîæÁõÆÂΩï
          mkdir -p hf-data/galaxy_output_data

          # C. ‰ΩøÁî® SCP ÊãâÂèñÊï∞ÊçÆ (ÂèçÂêëÊìç‰Ωú)
          # -o StrictHostKeyChecking=no: Ë∑≥Ëøá SSH È¶ñÊ¨°ËøûÊé•ÁöÑ yes/no Á°ÆËÆ§
          # -r: ÈÄíÂΩí‰∏ãËΩΩÊñá‰ª∂Â§π
          echo "Starting download from Aliyun (approx 2GB)..."
          sshpass -e scp -o StrictHostKeyChecking=no -r root@8.159.137.183:/var/www/galaxy_data/my_model_galaxy/* hf-data/galaxy_output_data/
          
          # D. Ê£ÄÊü•‰∏Ä‰∏ãÊòØÂê¶‰∏ãËΩΩÊàêÂäü
          ls -lh hf-data/galaxy_output_data/ | head -n 5

      # 4. Êé®ÈÄÅÂà∞ Hugging Face
      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: "MrYaoYaozhu"
          HF_SPACE_NAME: "ModelGalaxy"
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # A. ÂÖãÈöÜ HF ‰ªìÂ∫ì
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME /tmp/hf_space
          
          # B. Ê∏ÖÁêÜÊóßÊñá‰ª∂ (ÂÖ®Ê∏ÖÁêÜÔºåÂáÜÂ§áË¶ÜÁõñ)
          cd /tmp/hf_space
          find . -maxdepth 1 ! -name '.git' ! -name '.gitattributes' ! -name 'README.md' ! -name '.' -exec rm -rf {} +
          
          # C. ÂºÄÂêØ Git LFS (ÈáçË¶ÅÔºÅÂõ†‰∏∫Êï∞ÊçÆÊúâ 2G)
          git lfs install
          # ËøΩË∏™ÊâÄÊúâ json Êñá‰ª∂ (ÂÅáËÆæ‰Ω†ÁöÑÊï∞ÊçÆÊòØ jsonÔºåÂ¶ÇÊûúÊòØÂÖ∂‰ªñÊ†ºÂºèËØ∑‰øÆÊîπÔºåÊàñËÄÖÁõ¥Êé•ËøΩË∏™Êï¥‰∏™Êñá‰ª∂Â§π)
          git lfs track "hf-data/galaxy_output_data/**"
          
          # D. Â§çÂà∂Êñ∞‰ª£Á†Å + ÂàöÂàö‰∏ãËΩΩÁöÑÊï∞ÊçÆ
          # Ê≥®ÊÑèÔºö$GITHUB_WORKSPACE ÈáåÁé∞Âú®Â∑≤ÁªèÂåÖÂê´‰∫Ü hf-data Êñá‰ª∂Â§π
          cp -r $GITHUB_WORKSPACE/* .
          
          # E. ÂÜçÊ¨°Ê∏ÖÁêÜ‰∏çÈúÄË¶ÅÁöÑ PPT
          rm -f "ÂàùËµõPPT.pdf" "Â§çËµõPPT.pdf"
          rm -rf .git/modules

          # F. Ëá™Âä®ÁîüÊàê README ÈÖçÁΩÆ
          echo "---
          title: Model Galaxy
          emoji: üåå
          colorFrom: blue
          colorTo: purple
          sdk: docker
          pinned: false
          ---" > README_HEADER.md
          
          if [ -f "README.md" ]; then
            cat README_HEADER.md README.md > README_NEW.md
            mv README_NEW.md README.md
          else
            mv README_HEADER.md README.md
          fi
          rm README_HEADER.md

          # G. Êèê‰∫§Âπ∂Êé®ÈÄÅ
          git add .
          git commit -m "Deploy: auto-fetched aliyun data" --allow-empty
          git push --force